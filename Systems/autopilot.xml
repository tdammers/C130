<?xml version="1.0"?>
<PropertyList>
    <!-- lateral modes -->
    <!-- base lateral modes -->
    <filter>
        <name>Wing Leveler to Target Roll Deg</name>
        <condition>
            <equals>
                <property>/autopilot/locks/heading</property>
                <value>wing-leveler</value>
            </equals>
        </condition>
        <type>gain</type>
        <gain>1</gain>
        <input><value>0</value></input>
        <output>/autopilot/internal/target-roll-deg</output>
    </filter>

    <pi-simple-controller>
        <name>CDI integrator</name>
        <debug>false</debug>
        <config>
            <Kp>-4.0</Kp>
            <Ki>-0.1</Ki>
        </config>
        <!-- <input>/instrumentation/nav[0]/crosstrack-error-m</input> -->
        <input>/instrumentation/nav[0]/heading-needle-deflection</input>
        <output>/autopilot/internal/intercept-angle-deg</output>
        <min>-45.0</min>
        <max>45.0</max>
    </pi-simple-controller>

    <filter>
        <name>NAV1 intercept course</name>
        <type>gain</type>
        <gain>1</gain>
        <input>
            <expression>
                <sum>
                    <property>/instrumentation/nav[0]/radials/selected-deg</property>
                    <property>/autopilot/internal/intercept-angle-deg</property>
                </sum>
            </expression>
        </input>
        <output>/autopilot/internal/intercept-heading-deg</output>
        <period>
            <min>0</min>
            <max>360</max>
        </period>
    </filter>

    <filter>
        <name>NAV1 Intercept Course Error</name>
        <type>gain</type>
        <gain>1</gain>
        <input>
            <expression>
                <difference>
                    <property>/autopilot/internal/intercept-heading-deg</property>
                    <property>/orientation/heading-magnetic-deg</property>
                </difference>
            </expression>
        </input>
        <output>/autopilot/internal/intercept-heading-error-deg</output>
        <period>
            <min>-180</min>
            <max>180</max>
        </period>
    </filter>

    <filter>
        <name>Heading Bug Error</name>
        <type>gain</type>
        <gain>1</gain>
        <input>
            <expression>
                <difference>
                    <property>/autopilot/settings/heading-bug-deg</property>
                    <property>/orientation/heading-magnetic-deg</property>
                </difference>
            </expression>
        </input>
        <output>/autopilot/internal/heading-bug-error-deg</output>
        <period>
            <min>-180</min>
            <max>180</max>
        </period>
    </filter>

    <pi-simple-controller>
        <name>Heading bug error to roll</name>
        <enable>
            <condition>
                <!-- HDG HOLD selected -->
                <equals>
                    <property>/autopilot/locks/heading</property>
                    <value>dg-heading-hold</value>
                </equals>
            </condition>
        </enable>
        <input>/autopilot/internal/heading-bug-error-deg</input>
        <reference>0</reference>
        <output>/autopilot/internal/target-roll-deg</output>
        <Kp>-2.0</Kp>
        <Ki>-0.02</Ki>
        <min>-30</min>
        <max>30</max>
    </pi-simple-controller>

    <pi-simple-controller>
        <name>True heading error to roll</name>
        <enable>
            <condition>
                <equals>
                    <property>/autopilot/locks/heading</property>
                    <value>true-heading-hold</value>
                </equals>
            </condition>
        </enable>
        <input>/autopilot/internal/true-heading-error-deg</input>
        <reference>0</reference>
        <output>/autopilot/internal/target-roll-deg</output>
        <Kp>-2.0</Kp>
        <Ki>-0.02</Ki>
        <min>-30</min>
        <max>30</max>
    </pi-simple-controller>

    <pi-simple-controller>
        <name>Intercept course error to roll</name>
        <enable>
            <condition>
                <!-- NAV1 post-capture -->
                <equals>
                    <property>/autopilot/locks/heading</property>
                    <value>nav1-hold</value>
                </equals>
            </condition>
        </enable>
        <input>/autopilot/internal/intercept-heading-error-deg</input>
        <reference>0</reference>
        <output>/autopilot/internal/target-roll-deg</output>
        <Kp>-2.0</Kp>
        <Ki>-0.02</Ki>
        <min>-30</min>
        <max>30</max>
    </pi-simple-controller>

    <pid-controller>
        <name>Roll controller</name>
        <debug>false</debug>
        <enable>
            <condition>
                <or>
                    <equals>
                        <property>/autopilot/locks/heading</property>
                        <value>wing-leveler</value>
                    </equals>
                    <equals>
                        <property>/autopilot/locks/heading</property>
                        <value>dg-heading-hold</value>
                    </equals>
                    <equals>
                        <property>/autopilot/locks/heading</property>
                        <value>nav1-hold</value>
                    </equals>
                    <equals>
                        <property>/autopilot/locks/heading</property>
                        <value>true-heading-hold</value>
                    </equals>
                </or>
            </condition>
        </enable>
        <input>
            <prop>/orientation/roll-deg</prop>
        </input>
        <reference>
            <prop>/autopilot/internal/target-roll-deg</prop>
        </reference>
        <output>
            <prop>/controls/flight/aileron</prop>
        </output>
        <config>
            <Kp>0.011</Kp>
            <Ti>30.0</Ti>
            <Td>0.0</Td>
            <u_min>-1.0</u_min>
            <u_max>1.0</u_max>
        </config>
    </pid-controller>
    
    <!-- vertical modes -->
    <!-- vertical capture logic -->
    <filter>
        <name>Alt capture distance</name>
        <debug>false</debug>
        <type>gain</type>
        <gain>1</gain>
        <input>
            <expression>
                <abs>
                    <difference>
                        <property>/instrumentation/altimeter/indicated-altitude-ft</property>
                        <property>/autopilot/settings/target-altitude-ft</property>
                    </difference>
                </abs>
            </expression>
        </input>
        <output>/autopilot/internal/altitude-capture-distance-ft</output>
    </filter>

    <filter>
        <name>G/S capture diff</name>
        <debug>false</debug>
        <type>gain</type>
        <gain>1</gain>
        <input>
            <expression>
                <abs>
                    <property>/instrumentation/nav[0]/gs-needle-deflection-norm</property>
                </abs>
            </expression>
        </input>
        <output>/autopilot/internal/gs-capture-diff</output>
    </filter>

    <state-machine>
        <name>Vertical Capture Logic</name>
        <debug>false</debug>

        <branch>/autopilot/internal/vertical-capture</branch>
        <state>
            <name>init</name>
            <enter>
                <command>property-assign</command>
                <property>/autopilot/internal/altitude-armed</property>
                <value type="string"></value>
            </enter>
        </state>
        <state>
            <name>armed</name>
            <enter>
                <command>property-assign</command>
                <property>/autopilot/internal/altitude-armed</property>
                <value>altitude-hold</value>
            </enter>
            <exit>
                <command>property-assign</command>
                <property>/autopilot/internal/altitude-armed</property>
                <value type="string"></value>
            </exit>
        </state>
        <state>
            <name>captured</name>
            <enter>
                <command>property-assign</command>
                <property>/autopilot/locks/altitude</property>
                <value>altitude-hold</value>
            </enter>
        </state>
        <state>
            <name>app-armed</name>
            <enter>
                <command>property-assign</command>
                <property>/autopilot/internal/gs-captured</property>
                <value type="bool">false</value>
            </enter>
            <exit>
                <command>property-assign</command>
                <property>/autopilot/internal/altitude-armed</property>
                <value type="string"></value>
            </exit>
        </state>
        <state>
            <name>app-captured</name>
            <enter>
                <command>property-assign</command>
                <property>/autopilot/internal/gs-captured</property>
                <value type="bool">true</value>
            </enter>
            <exit>
                <command>property-assign</command>
                <property>/autopilot/internal/gs-captured</property>
                <value type="bool">false</value>
            </exit>
        </state>

        <!-- disable all logic when vertical mode deselected -->
        <transition>
            <name>disarm</name>
            <source>captured</source>
            <source>armed</source>
            <source>app-captured</source>
            <source>app-armed</source>
            <target>init</target>
            <condition>
                <equals>
                    <property>/autopilot/locks/altitude</property>
                    <value type="string"></value>
                </equals>
            </condition>
        </transition>

        <!-- arm capture mode when vertical speed mode selected -->
        <transition>
            <name>arm</name>
            <source>init</source>
            <source>captured</source>
            <source>app-armed</source>
            <source>app-captured</source>
            <target>armed</target>
            <condition>
                <equals>
                    <property>/autopilot/locks/altitude</property>
                    <value>vertical-speed-hold</value>
                </equals>
            </condition>
        </transition>

        <!-- arm app-capture mode when gs1 mode selected -->
        <transition>
            <name>arm</name>
            <source>init</source>
            <source>captured</source>
            <source>armed</source>
            <target>app-armed</target>
            <condition>
                <equals>
                    <property>/autopilot/locks/altitude</property>
                    <value>gs1-hold</value>
                </equals>
            </condition>
        </transition>

        <!-- enable capture mode and target current altitude when altitude hold selected -->
        <transition>
            <name>hold</name>
            <source>armed</source>
            <source>app-armed</source>
            <source>app-captured</source>
            <source>init</source>
            <target>captured</target>
            <condition>
                <and>
                    <equals>
                        <property>/autopilot/locks/altitude</property>
                        <value>altitude-hold</value>
                    </equals>
                    <equals>
                        <property>/autopilot/internal/altitude-armed</property>
                        <value>altitude-hold</value>
                    </equals>
                </and>
            </condition>
            <binding>
                <command>property-assign</command>
                <property>/autopilot/internal/target-altitude-ft</property>
                <property>/instrumentation/altimeter/indicated-altitude-ft</property>
            </binding>
            <binding>
                <command>property-assign</command>
                <property>/autopilot/settings/target-altitude-ft</property>
                <property>/instrumentation/altimeter/indicated-altitude-ft</property>
            </binding>
        </transition>

        <!-- enable capture mode when within 100ft of target altitude -->
        <transition>
            <name>capture</name>
            <source>armed</source>
            <target>captured</target>
            <condition>
                <less-than>
                    <property>/autopilot/internal/altitude-capture-distance-ft</property>
                    <value>100</value>
                </less-than>
            </condition>
            <binding>
                <command>property-assign</command>
                <property>/autopilot/internal/target-altitude-ft</property>
                <property>/autopilot/settings/target-altitude-ft</property>
            </binding>
        </transition>

        <!-- enable app-capture mode when within 100ft of target altitude -->
        <transition>
            <name>G/S capture</name>
            <source>app-armed</source>
            <target>app-captured</target>
            <condition>
                <and>
                    <property>/instrumentation/nav[0]/gs-in-range</property>
                    <less-than>
                        <property>/autopilot/internal/gs-capture-diff</property>
                        <value>0.01</value>
                    </less-than>
                </and>
            </condition>
        </transition>
    </state-machine>

    <!-- base vertical modes -->
    <pid-controller>
        <name>Pitch hold</name>
        <debug>false</debug>
        <enable>
            <condition>
                <or>
                    <equals>
                        <property>/autopilot/locks/altitude</property>
                        <value>pitch-hold</value>
                    </equals>
                    <equals>
                        <property>/autopilot/locks/altitude</property>
                        <value>vertical-speed-hold</value>
                    </equals>
                    <equals>
                        <property>/autopilot/locks/altitude</property>
                        <value>altitude-hold</value>
                    </equals>
                    <equals>
                        <property>/autopilot/locks/altitude</property>
                        <value>gs1-hold</value>
                    </equals>
                </or>
            </condition>
        </enable>
        <input>
            <prop>/orientation/pitch-deg</prop>
        </input>
        <reference>
            <prop>/autopilot/internal/target-pitch-deg</prop>
        </reference>
        <output>
            <prop>/controls/flight/elevator</prop>
        </output>
        <config>
            <Kp>-0.7</Kp>
            <Ti>2.0</Ti>
            <Td>0.1</Td>
            <u_min>-0.5</u_min>
            <u_max>0.5</u_max>
        </config>
    </pid-controller>

    <filter>
        <name>Target pitch forward</name>
        <type>gain</type>
        <gain>1</gain>
        <debug>false</debug>
        <enable>
            <prop>/autopilot/locks/altitude</prop>
            <value>pitch-hold</value>
        </enable>
        <input>/autopilot/settings/target-pitch-deg</input>
        <output>/autopilot/internal/target-pitch-deg</output>
    </filter>

    <filter>
        <name>Target vertical speed forward</name>
        <type>gain</type>
        <gain>1</gain>
        <debug>false</debug>
        <enable>
            <prop>/autopilot/locks/altitude</prop>
            <value>vertical-speed-hold</value>
        </enable>
        <input>/autopilot/settings/vertical-speed-fpm</input>
        <output>/autopilot/internal/vertical-speed-fpm</output>
    </filter>

    <filter>
        <name>G/S vertical speed</name>
        <type>gain</type>
        <gain>1</gain>
        <debug>false</debug>
        <enable>
            <prop>/autopilot/locks/altitude</prop>
            <value>gs1-hold</value>
        </enable>
        <input>
            <condition>
                <property>/autopilot/internal/gs-captured</property>
            </condition>
            <property>/instrumentation/nav[0]/gs-rate-of-climb-fpm</property>
        </input>
        <input>
            <condition>
                <not><property>/autopilot/internal/gs-captured</property></not>
            </condition>
            <value>0</value>
        </input>
        <output>/autopilot/internal/vertical-speed-fpm</output>
    </filter>

    <filter>
        <name>Alt hold to vertical speed</name>
        <debug>false</debug>
        <enable>
            <prop>/autopilot/locks/altitude</prop>
            <value>altitude-hold</value>
        </enable>
        <type>gain</type>
        <gain>1</gain>
        <input>
            <expression>
                <product>
                    <difference>
                        <property>/autopilot/internal/target-altitude-ft</property>
                        <property>/instrumentation/altimeter/indicated-altitude-ft</property>
                    </difference>
                    <!-- attempt to capture altitude within 10 seconds -->
                    <value>6</value>
                </product>
            </expression>
        </input>
        <min>-1000</min>
        <max>1000</max>
        <output>/autopilot/internal/vertical-speed-fpm</output>
    </filter>

    <pi-simple-controller>
        <name>Vertical speed to target pitch</name>
        <debug>false</debug>
        <enable>
            <condition>
                <or>
                    <equals>
                        <property>/autopilot/locks/altitude</property>
                        <value>vertical-speed-hold</value>
                    </equals>
                    <equals>
                        <property>/autopilot/locks/altitude</property>
                        <value>altitude-hold</value>
                    </equals>
                    <equals>
                        <property>/autopilot/locks/altitude</property>
                        <value>gs1-hold</value>
                    </equals>
                </or>
            </condition>
        </enable>
        <input>
            <prop>/velocities/vertical-speed-fps</prop>
            <scale>60.0</scale>
        </input>
        <reference>
            <prop>/autopilot/internal/vertical-speed-fpm</prop>
        </reference>
        <output>
            <prop>/autopilot/internal/target-pitch-deg</prop>
        </output>
        <config>
            <Kp>0.002</Kp>
            <Ki>0.004</Ki>
            <u_min>-15</u_min>
            <u_max>15</u_max>
        </config>
    </pi-simple-controller>
</PropertyList>
